\documentclass{report}

\usepackage[utf8]{inputenc}
\usepackage{textgreek}
\usepackage{blindtext}
\usepackage[inference]{semantic}
\usepackage{multicol}
\usepackage{hyperref}
\usepackage[newfloat]{minted}
\usepackage{amssymb}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage{svg}
\usepackage[capitalise]{cleveref}
\usepackage{enumitem}
\usepackage{float}
\usepackage{microtype}
\usepackage[a4paper, margin=1in]{geometry}
\usepackage{fancyvrb, newverbs, xcolor}
\usepackage{caption}
\usepackage[UKenglish]{babel}
\usepackage[parfill]{parskip}

\definecolor{cverbbg}{gray}{0.93}
\newcommand{\vtilde}{$\sim\ $}

\newenvironment{equ}{\vspace{0mm}\captionsetup{type=listing}}{\vspace{2mm}}
\SetupFloatingEnvironment{listing}{name=Code Snippet}

\newcommand{\spipe}{\quad\lvert\quad}
\newcommand{\ctexttt}[1]{\colorbox{cverbbg}{\texttt{#1}}}
\newverbcommand{\cverb}
  {\setbox\verbbox\hbox\bgroup}
  {\egroup\colorbox{cverbbg}{\box\verbbox}}

\hypersetup{
    colorlinks = true,
    urlcolor = blue,
    linkcolor = blue,
    citecolor = red
}

\newcommand\MyBox[1]{
  \fbox{\lower0.75cm
    \vbox to 1.7cm{\vfil
      \hbox to 1.7cm{\hfil\parbox{1.4cm}{#1}\hfil}
      \vfil}%
  }%
}

\newcommand{\hs}{\mintinline{haskell}}
\newcommand{\mono}{\mintinline{text}}

\begin{document}

%Start of titlepage!
\begin{titlepage}
    \centering
    
    \textls{\textsc{\huge{Utrecht University}}}\\
    \vspace{5em}
    \textsc{\Large{Thesis Report}}\\
    \vspace{2em}
    \textsc{\large{Department of Information and Computing Sciences}}\\
    
    \vspace{3em}
    \hrulefill
    \vspace{4em}
    
    \huge{Embracing Core \& Supervising the Optimisation Pipeline}\\
    \vspace{1em}
    \Large{Empowering Haskell developers with a looking glass into the core2core pipeline}

    \vspace{4em}
    \hrulefill
    \vspace{3em}
   
    \begin{tabular}{p{0.5\textwidth}r}
        \textit{Author:} & \textit{Supervisors:}\\
        H.A. Peters, BSc & W. Swierstra\\
        h.a.peters@uu.nl & T. McDonall\\
        5917727 &
    \end{tabular}
    
    \vspace{3em}
    \textsc{December 2022}\\
    % \textsc{\textcolor{red}{Version: Draft 2}}
    
    \begin{figure}[b]
        \hspace{-1.25cm}
        \includegraphics{figs/UU_logo_2021_NL_RGB.png}
    \end{figure}
    
\end{titlepage}

\vspace*{\fill}
\begin{center}
\begin{minipage}{.7\textwidth}
\centerline{\textbf{Abstract}}
\input{chapters/Abstract.tex}
\end{minipage}
\end{center}
\vfill % equivalent to \vspace{\fill}

\thispagestyle{empty}

\newpage
\clearpage
\pagenumbering{roman}
\tableofcontents

\newpage
\clearpage
\pagenumbering{arabic}

%Add with newpage
\newpage

\input{chapters/Introduction.tex}

\chapter{Research Questions}


\paragraph{Main Question} 
How can GHCâ€™s core2core passes be captured and presented in such a way that core
inspection becomes a more successful, and easier task?

\hfill \break

\paragraph{Sub-Question 1} 
How does one efficiently navigate where small changes occur in two or more captures?

\paragraph{Sub-Question 2}
How to make viewing core more manageable using various display options?

\paragraph{Sub-Question 3}
How could performance regressions that have occurred in the past in popular Haskell projects,
have been resolved faster?

\input{chapters/Background.tex}
\newpage


\input{chapters/Methods.tex}
\newpage



\chapter{Results}

\section{Tour of the tool}
Basic outline to prepare for the 'experiments' ahead

\section{Lists vs Streams}
Here we discuss the basic of the stream paper, how it operates, why haskell has moved on by using join points and
finally how the compilation pipeline treats these 2.

\section{Diagnosing a failing inspection test}

Hearkening back to \mono{inspection-testing} discussed in \cref{section:introduction_inspection_testing}, we put
ourselves in the shoes of a programmer who gets surprised by a failing inspection test and reason how she might
employ HsComprehension to diagnose the problem. She breaks the process down into a number of steps.

\paragraph{1. Isolate the problem}
Modules typically contain more than 1 function and during the core2core transformations many more auxiliary functions are
added and many functions are inlined to produce exponentially more code. To get good data it is helpful to temporarily isolate the
failing test case into a separate module. She is able to reproduce the following minimal case:


\begin{minted}{haskell}
{-# LANGUAGE TemplateHaskell #-}

module InspectionTests where

import Test.Inspection
import qualified Data.Text as T
import qualified Data.Text.Encoding as TE
import Data.ByteString

countChars :: ByteString -> Int
countChars = T.length . T.toUpper . TE.decodeUtf8

-- the failing test case
inspect $ 'countChars `hasNoType` ''T.Text
\end{minted}

The following error is produced by the build:

\begin{minted}{sh}
app/InspectionTests.hs:21:1: countChars `hasNoType` Data.Text.Internal.Text failed:
# ...
# 700 lines of core as seen at the end of the core2core pipeline
# ...
\end{minted}

So despite isolating the problem, the amount of textual data generate is still unwieldy.
It is also incomplete in the sense that it does not show the process that produced this final
artefact.

\paragraph{2. Creating a dump}


% Trying to reach the same conclusion as https://github.com/haskell/text/issues/202 (recursing into the mentioned https://github.com/haskell/text/pull/348)


\section{Performance regression at Channable}

%https://github.com/haskell/text/issues/202
%https://github.com/haskell/text/pull/348
%
%Another performance regression: https://gitlab.haskell.org/ghc/ghc/-/issues/22207


\chapter{Discussion}

\section{Review of the tech stack}
Elm does not provide amazing performance given the domain (mostly due to being strict),
but it does make it easy to write Haskell like code over an AST and thus requires less skill
for other Haskell programmers to contribute to. The final result is also just a website which is
very minimal barrier to entry and can be used to share things.

\section{Information lost}
\mono{IdInfo} may vary among various instances referencing the same variable. Thus, our encoding with
usages only by name may lose information.

\section{Printing Core like GHC}
If we truly wish to be a useful tool for GHC developers and experts alike, we must respect
that the current core printer form is well established and should provide at least a mode in which
the tool prints in a very similar manner. This does not imply that a different beginner mode, as you
could call the current state of affairs, that prints a more readable, slightly desugared version, 
is not also invaluable in itself.



\section{Post Core factors}
Core2Core is not everything, like in this issue: https://github.com/channable/alfred-margaret/issues/24.
Things like STG and the backend are also part of the equation.

\bibliographystyle{abbrv}
\bibliography{refs}

\appendix
\clearpage
\pagenumbering{roman}

\end{document}
